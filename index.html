<!doctype html>
<html lang="nb">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Snake ‚Äì Gloser uke 45 ‚Ä¢ 6A Kampen skole</title>
<style>
:root{--bg:#0c1020;--panel:#151a2b;--ink:#eef3fb;--muted:#9fb1d1;--line:#223059;--good:#42d392;--bad:#ff6b6b}
*{box-sizing:border-box}
html,body{margin:0;min-height:100%;background:#0c1020;color:var(--ink);font:16px system-ui,Segoe UI,Roboto,Arial}
header{text-align:center;background:#151a2b;border-bottom:1px solid var(--line);padding:8px 14px}
h1{margin:0;font-size:18px}
.wrap{max-width:640px;margin:auto;padding:6px}
#canvasWrap{background:radial-gradient(640px 320px at 30% -8%,#18234a,#0c1020 60%);border:1px solid var(--line);border-radius:12px;padding:6px;margin:auto}
canvas{display:block;width:100%;height:auto;background:#0a1020;border:1px solid #1b274b;border-radius:10px;touch-action:none;outline:none}
#mobControls{display:grid;place-items:center;margin-top:8px}
#mobControls .row{display:flex;gap:10px;justify-content:center;margin-top:6px}
#mobControls button{width:56px;height:56px;font-size:26px;border-radius:12px;background:#1a274b;color:#fff;border:1px solid #223059;}
#mobControls button:active{transform:scale(.95)}
@media(min-width:900px){#mobControls{display:none}}
#ui{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:8px;text-align:center;margin-top:8px}
.chip{display:inline-flex;gap:6px;align-items:center;background:#1a2240;border:1px solid var(--line);border-radius:999px;padding:4px 10px;margin:2px 3px;font-size:14px}
button{appearance:none;background:#1b274b;color:var(--ink);border:1px solid var(--line);padding:8px 12px;border-radius:10px;font-weight:700;font-size:14px;cursor:pointer}
button:active{transform:translateY(1px)}
.btn-prim{background:#1b3b2e;border-color:#225a42}
#modal,#summary{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:50}
.card{width:min(92vw,420px);background:#0f1734;border:1px solid #2a3a68;border-radius:14px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.35);text-align:center}
#ans{width:100%;padding:10px 12px;font-size:18px;border-radius:10px;border:1px solid #2a3a68;background:#101833;color:#fff}
.row{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;justify-content:center}
.good{color:var(--good)}.bad{color:var(--bad)}
#hint{display:none;margin-top:8px;color:var(--muted);font-style:italic}
#fasitWrap{text-align:center;margin-top:12px;margin-bottom:16px}
table{width:100%;border-collapse:collapse;font-size:14px;margin-top:6px}
th,td{border:1px solid #2a3a68;padding:6px 8px;text-align:left}
th{background:#1a2240}
.summary-list{margin:10px 0;text-align:left}
.summary-list li{margin:4px 0}
#mistakes{display:none;margin-top:10px;max-height:220px;overflow:auto;text-align:left}
#mistakes table{font-size:13px}
</style>
</head>
<body>
<header><h1>Snake ‚Äì Gloser uke 45 ‚Ä¢ 6A Kampen skole</h1></header>

<div class="wrap" id="canvasWrap"><canvas id="game" width="480" height="320" tabindex="0"></canvas></div>

<div id="mobControls">
  <div class="row"><button id="up">‚¨ÜÔ∏è</button></div>
  <div class="row">
    <button id="left">‚¨ÖÔ∏è</button>
    <button id="down">‚¨áÔ∏è</button>
    <button id="right">‚û°Ô∏è</button>
  </div>
</div>

<div id="ui" class="wrap">
  <span class="chip">Poeng: <b id="score">0</b></span>
  <span class="chip">Liv: <b id="lives">‚ù§‚ù§‚ù§</b></span>
  <span class="chip">Fart: <b id="speedShow">7</b></span>
  <span class="chip">Topp: <b id="best">0</b></span>
  <span class="chip">Igjen: <b id="left">0</b></span><br>
  <button id="start" class="btn-prim">Start / Restart</button>
  <button id="pause">Pause</button>
  <label class="pill">Fart <input id="speed" type="range" min="4" max="16" value="7"></label>
</div>

<div id="fasitWrap" class="wrap">
  <button id="toggleFasit" class="btn-prim">Vis fasit ‚ñº</button>
  <div id="fasit" style="display:none"></div>
</div>

<!-- Sp√∏rsm√•l -->
<div id="modal">
  <div class="card">
    <p>Skriv engelsk for: <span id="norw" class="good"></span></p>
    <input id="ans" type="text" autocomplete="off" autocapitalize="none" spellcheck="false">
    <div id="hint"></div>
    <div class="row">
      <button id="check" class="btn-prim">Sjekk</button>
      <button id="showHint">Vis fasit</button>
      <button id="skip">Hopp over (‚Äì1 liv)</button>
    </div>
  </div>
</div>

<!-- Oppsummering -->
<div id="summary">
  <div class="card">
    <h3>Oppsummering</h3>
    <ul class="summary-list">
      <li><b>Riktige uten fasit:</b> <span id="sum_ok_nohint">0</span></li>
      <li><b>Riktige med fasit:</b> <span id="sum_ok_hint">0</span></li>
      <li><b>Feil uten fasit:</b> <span id="sum_bad_nohint">0</span></li>
      <li><b>Feil med fasit:</b> <span id="sum_bad_hint">0</span></li>
      <li><b>Poeng:</b> <span id="sum_pts">0</span></li>
      <li><b>Tid:</b> <span id="sum_time">0:00</span></li>
    </ul>
    <div class="row">
      <button id="toggleMistakes">Vis feilgloser ‚ñº</button>
      <button id="summaryClose" class="btn-prim">Spill igjen</button>
    </div>
    <div id="mistakes"></div>
  </div>
</div>

<script>
/* rAF polyfill */
(function(){var l=0,v=['ms','moz','webkit','o'];for(var i=0;i<v.length&&!window.requestAnimationFrame;i++){window.requestAnimationFrame=window[v[i]+'RequestAnimationFrame'];window.cancelAnimationFrame=window[v[i]+'CancelAnimationFrame']||window[v[i]+'CancelRequestAnimationFrame'];}
if(!window.requestAnimationFrame){window.requestAnimationFrame=function(cb){var c=Date.now(),t=Math.max(0,16-(c-l));var id=setTimeout(function(){cb(c+t);},t);l=c+t;return id;};}
if(!window.cancelAnimationFrame){window.cancelAnimationFrame=function(id){clearTimeout(id);};}})();

/* Safe localStorage */
var LS_OK=true;try{localStorage.setItem('__t','1');localStorage.removeItem('__t');}catch(e){LS_OK=false;}
function lsGet(k){if(!LS_OK)return"0";try{return localStorage.getItem(k);}catch(e){return"0";}}
function lsSet(k,v){if(!LS_OK)return;try{localStorage.setItem(k,v);}catch(e){}}

/* Gloser */
var PAIRS=[{en:"Decent",no:"ordentlig"},{en:"Grin",no:"smil"},{en:"Terrified",no:"veldig redd"},{en:"Wailed",no:"gr√•t"},{en:"Yelping",no:"bjeffende"},{en:"Leer",no:"sultent blikk"},{en:"Furry coat",no:"pelsk√•pe"},{en:"Flickers",no:"blunker i rykninger"},{en:"Whips out",no:"trekker frem"},{en:"Knickers",no:"underbukser"}];

/* Fasit-tabell */
var f=document.getElementById("fasit");
(function(){var html="<table><tr><th>Engelsk</th><th>Norsk</th></tr>";for(var i=0;i<PAIRS.length;i++){html+="<tr><td>"+PAIRS[i].en+"</td><td>"+PAIRS[i].no+"</td></tr>";}html+="</table>";f.innerHTML=html;})();
document.getElementById("toggleFasit").onclick=function(e){var open=f.style.display==="none";f.style.display=open?"block":"none";e.target.textContent=open?"Skjul fasit ‚ñ≤":"Vis fasit ‚ñº";};

/* DOM */
var cv=document.getElementById('game'),ctx=cv.getContext('2d');cv.setAttribute('tabindex','0');
var ui={score:document.getElementById('score'),lives:document.getElementById('lives'),best:document.getElementById('best'),
         speed:document.getElementById('speed'),speedShow:document.getElementById('speedShow'),
         start:document.getElementById('start'),pause:document.getElementById('pause'),
         left:document.getElementById('left')};
var modal=document.getElementById('modal'),norw=document.getElementById('norw'),ans=document.getElementById('ans'),
    checkBtn=document.getElementById('check'),skipBtn=document.getElementById('skip'),showHint=document.getElementById('showHint'),
    hint=document.getElementById('hint');
var sumEl={ok_nohint:document.getElementById('sum_ok_nohint'),ok_hint:document.getElementById('sum_ok_hint'),
           bad_nohint:document.getElementById('sum_bad_nohint'),bad_hint:document.getElementById('sum_bad_hint'),
           pts:document.getElementById('sum_pts'),time:document.getElementById('sum_time')};
var summary=document.getElementById('summary'), summaryClose=document.getElementById('summaryClose'),
    toggleMistakesBtn=document.getElementById('toggleMistakes'), mistakesDiv=document.getElementById('mistakes');

var LS_KEY="snake45_best";ui.best.textContent=lsGet(LS_KEY)||"0";

/* Mindre spillflate */
var grid=20;
var cols=Math.floor(cv.width/grid), rows=Math.floor(cv.height/grid);

/* Stabil fit (l√•ser til ~480√ó320) */
function fit(){
  var wrap=document.getElementById('canvasWrap');
  var w=Math.min(480, Math.max(360, Math.floor(wrap.getBoundingClientRect().width-12)));
  var h=Math.floor(w*2/3);
  if(cv.width!==w||cv.height!==h){cv.width=w;cv.height=h;cols=Math.floor(w/grid);rows=Math.floor(h/grid);}
}
window.addEventListener('resize',fit);

/* Blokker side-scroll ved piltaster/space (PC) */
function blockScrollKeys(e){
  var k=e.key||e.code||""; var c=e.keyCode||0;
  if(k==="ArrowUp"||k==="ArrowDown"||k==="ArrowLeft"||k==="ArrowRight"||k===" "||c===32||c===37||c===38||c===39||c===40){
    e.preventDefault();
  }
}
window.addEventListener('keydown',blockScrollKeys,{passive:false});

/* Utils */
function rand(n){return Math.floor(Math.random()*n);}
function norm(s){return s.replace(/\s+/g," ").replace(/^\s+|\s+$/g,"").toLowerCase();}
function hearts(n){return new Array(n+1).join("‚ù§");}
function flash(msg,ok,t){if(typeof t==="undefined")t=900;var e=document.createElement('div');e.textContent=msg;
e.style.position="fixed";e.style.left="50%";e.style.top="12px";e.style.transform="translateX(-50%)";
e.style.background=ok?"#1f503a":"#5b2230";e.style.color="#fff";e.style.padding="10px 14px";e.style.borderRadius="10px";e.style.zIndex=99;
document.body.appendChild(e);setTimeout(function(){if(e&&e.parentNode)e.parentNode.removeChild(e);},t);}
function fmtTime(ms){var s=Math.floor(ms/1000),m=Math.floor(s/60);s%=60;return m+":"+(s<10?"0"+s:s);}

/* Runde/statistikk */
var snake,dir,nextDir,score,lives,paused=true,loopId=null,lastTick=0,speedMs=1000/7;
var growth=0,usedHint=false;
var remaining=[], stats=null, mistakes=[];
var currentObj=null; // glosa for sist spiste eple
var apples=[]; // {x,y,obj}

/* Hjelpere */
function newStats(){
  return {start:Date.now(), end:0,
          ok_nohint:0, ok_hint:0, bad_nohint:0, bad_hint:0,
          points:0};
}
function updateLeft(){ ui.left.textContent=String(remaining.length); }
function copy(pt){return{x:pt.x,y:pt.y};}

/* Ledige celler */
function isOnSnake(x,y){
  for(var i=0;i<snake.length;i++){ if(snake[i].x===x && snake[i].y===y) return true; }
  return false;
}
function isOnApples(x,y){
  for(var i=0;i<apples.length;i++){ if(apples[i].x===x && apples[i].y===y) return true; }
  return false;
}
function freeCell(){
  var tries=0,x,y;
  do{
    x=rand(cols); y=rand(rows); tries++;
    if(tries>500) break;
  }while(isOnSnake(x,y) || isOnApples(x,y));
  return {x:x,y:y};
}

/* Plasser ALLE epler (ett per glose) */
function placeAllApples(){
  apples=[];
  for(var i=0;i<remaining.length;i++){
    var c=freeCell();
    apples.push({x:c.x,y:c.y,obj:remaining[i]});
  }
}

/* Reset / start */
function reset(){
  fit();
  remaining=PAIRS.slice(); // √©n runde gjennom alle
  stats=newStats();
  mistakes=[];
  snake=[{x:Math.floor(cols/2),y:Math.floor(rows/2)}];
  dir={x:1,y:0};nextDir={x:1,y:0};score=0;lives=3;growth=0;
  ui.score.textContent=String(score);ui.lives.textContent=hearts(3);
  placeAllApples(); updateLeft();
  paused=false;
  if(loopId)cancelAnimationFrame(loopId);
  draw();loopId=requestAnimationFrame(tick);
  cv.focus();
}

/* Tegn */
function draw(){
  ctx.fillStyle="#0a1020";ctx.fillRect(0,0,cv.width,cv.height);
  ctx.strokeStyle="rgba(34,48,89,.6)";
  var i;for(i=0;i<=cols;i++){ctx.beginPath();ctx.moveTo(i*grid,0);ctx.lineTo(i*grid,cv.height);ctx.stroke();}
  for(i=0;i<=rows;i++){ctx.beginPath();ctx.moveTo(0,i*grid);ctx.lineTo(cv.width,i*grid);ctx.stroke();}
  /* alle eplene */
  ctx.font="bold 16px system-ui";ctx.textAlign="center";ctx.textBaseline="middle";
  for(i=0;i<apples.length;i++){
    var a=apples[i];
    ctx.fillText("üçé",a.x*grid+grid/2,a.y*grid+grid/2);
  }
  /* slange */
  ctx.fillStyle="#79c8ff";
  for(i=0;i<snake.length;i++){
    var s=snake[i],x=s.x*grid,y=s.y*grid;ctx.fillRect(x+2,y+2,grid-4,grid-4);
    if(i===0){ctx.fillStyle="#0b1020";ctx.fillRect(x+5,y+7,3,3);ctx.fillRect(x+grid-8,y+7,3,3);ctx.fillStyle="#79c8ff";}
  }
}

/* Loop */
function tick(ts){
  fit();
  if(remaining.length===0 && summary.style.display!=="flex"){ endRound(); return; }
  if(paused){draw();loopId=requestAnimationFrame(tick);return;}
  if(ts-lastTick<speedMs){loopId=requestAnimationFrame(tick);return;}
  lastTick=ts;

  if(!(nextDir.x===-dir.x&&nextDir.y===-dir.y))dir=nextDir;

  var head=copy(snake[0]);head.x+=dir.x;head.y+=dir.y;
  if(head.x<0)head.x=cols-1;else if(head.x>=cols)head.x=0;
  if(head.y<0)head.y=rows-1;else if(head.y>=rows)head.y=0;

  /* kollisjon med egen hale */
  for(var i=0;i<snake.length;i++){ if(snake[i].x===head.x&&snake[i].y===head.y){ loseLife("Halen"); loopId=requestAnimationFrame(tick); return; } }

  snake.unshift(head);

  /* spiste et av mange epler? */
  var ateIndex=-1;
  for(var j=0;j<apples.length;j++){
    if(apples[j].x===head.x && apples[j].y===head.y){ ateIndex=j; break; }
  }
  if(ateIndex>-1){
    /* sett opp sp√∏rsm√•l for akkurat dette eplet */
    var eaten=apples.splice(ateIndex,1)[0];   // fjern eplet fra brettet
    currentObj=eaten.obj;
    /* fjern glosa fra remaining n√• (viser tydelig "Igjen") */
    for(var r=0;r<remaining.length;r++){ if(remaining[r]===currentObj){ remaining.splice(r,1); break; } }
    updateLeft();
    paused=true; ask(); /* √•pner modal */
  }else{
    if(growth>0) growth--; else snake.pop();
  }

  draw();loopId=requestAnimationFrame(tick);
}

/* Sp√∏rsm√•l */
function ask(){
  if(!currentObj){ endRound(); return; }
  usedHint=false; norw.textContent=currentObj.no; ans.value=""; hint.style.display="none";
  modal.style.display="flex";
  setTimeout(function(){try{ans.focus();}catch(e){}},50);
}
function registerMistake(userAns){
  mistakes.push({en:currentObj.en,no:currentObj.no,usedHint:usedHint,answer:userAns||""});
}
function handle(ok){
  var userAns=ans.value||"";
  modal.style.display="none";
  try{cv.focus();}catch(e){}
  var pts=usedHint?5:10;

  if(ok){
    score+=pts; ui.score.textContent=String(score); growth+=2; speedMs=Math.max(1000/16,speedMs*0.985);
    if(usedHint) stats.ok_hint++; else stats.ok_nohint++;
    stats.points=score; flash("Riktig +"+pts,true);
  }else{
    if(usedHint) stats.bad_hint++; else stats.bad_nohint++;
    registerMistake(userAns);
    loseLife("Feil");
    if(lives<=0){ return; } /* endRound() kalles i loseLife */
  }

  currentObj=null; /* ferdig med denne glosa */

  if(remaining.length===0){ endRound(); return; }

  paused=false;
}
function check(){ if(!currentObj) return; handle(norm(ans.value)===norm(currentObj.en)); }
document.getElementById('check').onclick=function(){check();};
ans.addEventListener('keydown',function(e){
  e.stopPropagation(); // la input bruke mellomrom og piltaster
});
ans.addEventListener('keydown',function(e){ if(e.key==="Enter"||e.keyCode===13) check(); });
document.getElementById('showHint').onclick=function(){ usedHint=true; hint.style.display="block"; hint.textContent="Fasit: "+currentObj.en+" (5 poeng)"; };
document.getElementById('skip').onclick=function(){
  modal.style.display="none"; try{cv.focus();}catch(e){}
  stats.bad_nohint++; registerMistake("(hoppet over)");
  loseLife("Hoppet over");
  if(lives<=0){ return; }
  currentObj=null;
  if(remaining.length===0){ endRound(); return; }
  paused=false;
};

/* Liv */
function loseLife(r){
  lives--; ui.lives.textContent=hearts(Math.max(lives,0)); flash(r+"! ‚Äì 1 liv", false, 1000);
  if(lives<=0){ endRound(); return; }
  snake=[{x:Math.floor(cols/2),y:Math.floor(rows/2)}]; dir={x:1,y:0}; nextDir={x:1,y:0}; growth=0;
}

/* Oppsummering */
function buildMistakesTable(){
  if(!mistakes.length){
    mistakesDiv.innerHTML="<p class='good'>Ingen feil ‚Äì bra jobba!</p>";
    return;
  }
  var html="<table><tr><th>Engelsk (fasit)</th><th>Norsk</th><th>Ditt svar</th><th>Hint?</th></tr>";
  for(var i=0;i<mistakes.length;i++){
    var m=mistakes[i];
    html+="<tr><td>"+m.en+"</td><td>"+m.no+"</td><td>"+(m.answer?m.answer:"")+"</td><td>"+(m.usedHint?"Ja":"Nei")+"</td></tr>";
  }
  html+="</table>";
  mistakesDiv.innerHTML=html;
}
function endRound(){
  paused=true;
  var now=Date.now();
  if(stats && !stats.end){ stats.end=now; }
  var best=parseInt(lsGet(LS_KEY)||"0",10)||0;
  if(score>best){ lsSet(LS_KEY,String(score)); ui.best.textContent=String(score); }
  sumEl.ok_nohint.textContent=String(stats.ok_nohint||0);
  sumEl.ok_hint.textContent=String(stats.ok_hint||0);
  sumEl.bad_nohint.textContent=String(stats.bad_nohint||0);
  sumEl.bad_hint.textContent=String(stats.bad_hint||0);
  sumEl.pts.textContent=String(score||0);
  var elapsed = (stats && stats.start)? (now - stats.start) : 0;
  sumEl.time.textContent=fmtTime(elapsed);
  buildMistakesTable();
  mistakesDiv.style.display="none";
  toggleMistakesBtn.textContent="Vis feilgloser ‚ñº";
  summary.style.display="flex";
}
summaryClose.onclick=function(){ summary.style.display="none"; reset(); };
toggleMistakesBtn.onclick=function(){
  var show=mistakesDiv.style.display==="none";
  mistakesDiv.style.display=show?"block":"none";
  toggleMistakesBtn.textContent=show?"Skjul feilgloser ‚ñ≤":"Vis feilgloser ‚ñº";
};

/* Kontroller */
function setDir(dx,dy){ if(dx===-dir.x&&dy===-dir.y) return; nextDir={x:dx,y:dy}; }
window.addEventListener('keydown',function(e){
  var k=(e.key||e.code||"").toLowerCase();
  if(k==="arrowup"||k==="w") setDir(0,-1);
  else if(k==="arrowdown"||k==="s") setDir(0,1);
  else if(k==="arrowleft"||k==="a") setDir(-1,0);
  else if(k==="arrowright"||k==="d") setDir(1,0);
});
document.getElementById('up').onclick=function(){setDir(0,-1);};
document.getElementById('down').onclick=function(){setDir(0,1);};
document.getElementById('left').onclick=function(){setDir(-1,0);};
document.getElementById('right').onclick=function(){setDir(1,0);};

/* UI */
ui.start.onclick=function(){speedMs=1000/Number(ui.speed.value||7);ui.speedShow.textContent=String(ui.speed.value||7);reset();};
ui.pause.onclick=function(){paused=!paused;ui.pause.textContent=paused?"Fortsett":"Pause";};
ui.speed.addEventListener('input',function(){ui.speedShow.textContent=String(ui.speed.value||7);speedMs=1000/Number(ui.speed.value||7);});

/* Boot */
fit();reset();
</script>
</body>
</html>
